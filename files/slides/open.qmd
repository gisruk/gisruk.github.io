---
title: "<span style='font-size:.75em; font-weight: 700;'>GISRUK 2024</span><span style='font-size:.75em; font-weight: 500'><br> for gridmap design<br>  and analysis</span>"
subtitle: "<br><br><span style='color:#525252; font-size:1.2em;'>*-- Roger Beecham*</span>"
format: 
   revealjs:
     transition: fade
     theme: theme/slides-theme.scss
     css: theme/style.css
     footer: 'GISRUK 2024 | University of Leeds'
     mainfont: Jost
     logo: "../img/favicon/gisruk.png"
---


### Gridmaps 

<br>

::: {.columns}


::: {.column width="65%"}

![](img/wp_electoral_full.png){fig-align="center"}
:::

::: {.column width="30%"}
![](img/wp_banner.png){width="100%" fig-align="center"}
![](img/wp_legend.png){fig-align="center"}

:::

:::


::: footer
:::

::: {.notes}

Maps with spatial units of the same graphic size and shape, ordered with an approximate spatial arrangement. 

Means that can use in maps chart types that show distributions of values, multivariate structrure.

There excellent examples of their use in data journalism...
And I also think there are interesting applications for this in spatial anaysis -- beacuse the addition of a spatial positioning to 1D, 2D, graphh structure in data, allow us to generate spatial features -- in statistical terms, estimands -- that are unique to the graphic itself. 

Reflect on this at end of talk.

:::

---

### Gridmaps 

![](img/2021_comp.png){.absolute top=115 left=10 width="80%"}


::: footer
:::

::: {.notes}

Maps with spatial units of the same graphic size and shape, ordered with an approximate spatial arrangement. 

Means that can use in maps chart types that show distributions of values, multivariate structrure.

There excellent examples of their use in data journalism...
And I also think there are interesting applications for this in spatial anaysis -- beacuse the addition of a spatial positioning to 1D, 2D, graphh structure in data, allow us to generate spatial features -- in statistical terms, estimands -- that are unique to the graphic itself. 

Reflect on this at end of talk.

:::

---


<br>

::: {style="font-size: 110%; font-weight: 500;"}

1. `gridmappr`<br> for generating layouts 
<br><br>

2. `ggplot2`<br> for gridmap design 
<br><br>

3. `tidyverse`<br> for gridmap analysis

::: 

![](img/gridmappr.svg){.absolute top=150 left=700 width="30%"}


::: footer
:::

::: {.notes}
Mostly talk about how to generate these layouts, and subsequently graphics, in high-level, declarative coding style that we use nowadays for analysis.
:::




# `gridmappr` for generating layouts

---


### Generating layouts

<br>

::: {.columns}


::: {.column width="90%"}

![](img/smwg.png){fig-align="center"}
:::


:::

::: footer
:::

::: {.notes}

The approach that my package uses is based on work in this paper.


:::

---


### Generating layouts

<br>

::: {.columns}


::: {.column width="70%"}

![](img/gridmap_observable.png){fig-align="center"}

:::

:::

::: footer
:::

::: {.notes}

And also later implemented in javascript in this Observable notebook by Jo Wood.


:::


---

### `gridmappr` for generating layouts

::: {.columns}

::: {.column width="35%"}
::: {.fragment .fade-in}
![](img/france_map.png){.absolute top=150 left=0 width="30%"}
:::
::: {.fragment .fade-in}
![](img/france_grid.png){.absolute top=180 left=320 width="32%"}
:::
:::


::: {.column width="50%"}
::: {.fragment .fade-in}
![](img/0_6_1312_c.png){.absolute top=140 left=730 width="35%"}
:::
:::



:::


::: footer
:::

::: {.notes}

Gridmappr uses this latter approach.

1. Start with real spatial units 
2. Specify a grid containing at least as many cells as spatial units in the real geography -- these are candidate positions that spatial units might be allocated to.
3. Allocate to grid such that sum of distance distortion between real and grid centroids is minimised. 


:::

---


### `gridmappr` for generating layouts


::: {.columns}

::: {.column width="35%"}

![](img/france_map.png){.absolute top=150 left=0 width="30%"}

![](img/france_grid.png){.absolute top=180 left=320 width="32%"}

:::


::: {.column width="50%"}

![](img/0_6_1213_dis.png){.absolute top=140 left=730 width="35%"}
:::
:::





::: footer
:::

::: {.notes}

Gridmappr uses this latter approach.

1. Start with real spatial units 
2. Specify a grid containing at least as many cells as spatial units in the real geography -- these are candidate positions that spatial units might be allocated to.
3. Allocate to grid such that sum of distance distortion between real and grid centroids is minimised. 


:::

---


### `gridmappr` for generating layouts

<br>

:::{.columns}

::: {.column width="40%" style="font-size: 65%;"}



```{r}
#| eval: false
#| echo: true
points_to_grid(
  pts=...,
  n_row=...,
  n_col=...,
  compactness=...,
  spacers=list(...)
)
```


:::

::: {.column width="60%" .fragment .fade-in style="font-size: 60%;"}

* `pts` A tibble of geographic points `(x,y)` to be allocated to a grid.
    
* `n_row`  Maximum number of rows in grid.
    
* `n_col` Maximum number of columns in grid.
    
* `compactness` Parameter between `0` and `1` where `0` allocates towards edges, `0.5` preserves scaled geographic location and `1` allocates towards centre of grid.
    
* `spacers` Optional list of grid cell locations defining grid location of fixed spacers which cannot be allocated points. Coordinates are in `(row, column)` order with the origin `(1,1)` in the bottom-left. The default is an empty list.


:::

:::

::: footer
:::

::: {.notes}

SMWGs -- introduces a grid of candidate positions.

Allocated to grid positions based on mutliple criteria -- distance, shape preserving criteria. 
4. Compactness parameter -- useful for geographies with holes in them
5. Spacers -- useful for geographies with non-contiguous


points_to_grid 
1. Given a set of geographic point locations : show
2. And a grid of stated row, col dimensions
3. Algorithm places points in grid cell such that total squared distances btw geog and grid is minimised.  
4. If the number of grid cells is greater than the number of points to allocate, the algorithm chooses where to leave gaps
5. So this is a version of Meulemans 2017



1. So this is a version of Meulemans 2017
2. But constrained by one other parameter : compactness
3. A value of 1 places points as close to the grid as possible; a values of .5 attempts to place each point at its relative geographic position scaled within the bounds of the grid. A value of 1 attempts to place each point as close to the centre of the grid as possible while as compactness tends towards 0, cells are allocated increasingly towards the edge of the grid.
4. Its effect varies depending on how many free spaces there are in the grid.


gridmappr is an R implementation of Jo Wood's Observable notebook on gridmap allocation.
As with this, we use Linear Programming -- via ompr --  for describing and solving the layout constraints


:::
  
---

### `gridmappr` for generating layouts

<br>

:::{.columns}

::: {.column width="40%" style="font-size: 65%;"}


```{r}
#| eval: false
#| echo: true
#| code-line-numbers: "2,3,4"
points_to_grid(
  pts=...,
  n_row=...,
  n_col=...,
  compactness=...,
  spacers=list(...)
)
```


:::


::: {.column width="60%" style="font-size: 60%;"}

* `pts` A tibble of geographic points `(x,y)` to be allocated to a grid.
    
* `n_row`  Maximum number of rows in grid.
    
* `n_col` Maximum number of columns in grid.

:::

:::

::: footer
:::


---

### `gridmappr` for generating layouts

<br>

:::{.columns}

::: {.column width="40%" style="font-size: 60%;"}

```{r}
#| eval: false
#| echo: true
points_to_grid(
  pts=...,
  n_row=...,
  n_col=...,
  compactness=...,
  spacers=list(...)
)
```


:::

::: {.column width="60%" style="font-size: 50%;"}

```{r}
#| eval: false
#| echo: true
#    row col               area_name
# 1    9   7                   Aisne
# 2    5   6                  Allier
# 3    4   9            Hautes-Alpes
# 4    3  10         Alpes-Maritimes
# 5    7   9             Haute-Saône
# 6    1   3         Hautes-Pyrénées
# 7    8   8                    Aube
# 8    1   5                    Aude
# 9    2   6                 Aveyron
# 10   1   7                 Hérault
# 11   8   5          Hauts-de-Seine
# 12  10   2                Calvados
# 13   4   5                  Cantal
# 14   4   1       Charente-Maritime
# 15   6   5                    Cher
# 16   4   8                   Isère
# 17   3   6                  Lozère
# 18   9   1           Côtes-d'Armor
# 19   8   6            Val-de-Marne
# 20   9   5                   Paris
```


::: 
:::


::: footer
:::


---


### `gridmappr` for generating layouts


![](img/grid_1010.png){.absolute top=160 left=0 width="35%"}
![](img/grid_1212.png){.absolute top=160 left=330 width="35%"}
![](img/grid_1414.png){.absolute top=160 left=660 width="35%"}


::: {.fragment .fade-in}
![](img/0_6_1010.png){.absolute top=160 left=0 width="35%"}
![](img/0_6_1212.png){.absolute top=160 left=330 width="35%"}
![](img/0_6_1414.png){.absolute top=160 left=660 width="35%"}
:::







::: footer
:::

::: {.notes}



4. The larger the grid dimensions -- the more cells the grid contains -- the closer to real geography.
5. The smaller the grid, the more context is lost.


:::

---


### `gridmappr` for generating layouts

<br>

:::{.columns}

::: {.column width="40%" style="font-size: 70%;"}


```{r}
#| eval: false
#| echo: true
#| code-line-numbers: "5"
points_to_grid(
  pts=...,
  n_row=...,
  n_col=...,
  compactness=...,
  spacers=list(...)
)
```

:::

::: {.column width="60%" style="font-size: 60%;"}


* `compactness` Parameter between `0` and `1` where `0` allocates towards edges, `0.5` preserves scaled geographic location and `1` allocates towards centre of grid.
    


::: 
:::


::: footer
:::


---

### `gridmappr` for generating layouts


![](img/1_1213_grid.png){.absolute top=160 left=0 width="35%"}

![](img/0_5_1213_grid.png){.absolute top=160 left=330 width="35%"}

![](img/0_1213_grid.png){.absolute top=160 left=660 width="35%"}

:::{.fragment .fade-in}

![](img/1_1213.png){.absolute top=160 left=0 width="35%"}

:::

:::{.fragment .fade-in}

![](img/0_1213.png){.absolute top=160 left=660 width="35%"}

:::

:::{.fragment .fade-in}

![](img/0_5_1213.png){.absolute top=160 left=330 width="35%"}

:::

::: footer
:::


---


### `gridmappr` for generating layouts

<br>

:::{.columns}

::: {.column width="40%" style="font-size: 70%;"}


```{r}
#| eval: false
#| echo: true
#| code-line-numbers: "6"
points_to_grid(
  pts=...,
  n_row=...,
  n_col=...,
  compactness=...,
  spacers=list(...)
)
```



:::

::: {.column width="60%" style="font-size: 60%;"}


* `spacers` Optional list of grid cell locations defining grid location of fixed spacers which cannot be allocated points. Coordinates are in `(row, column)` order with the origin `(1,1)` in the bottom-left. The default is an empty list.
    

::: 
:::

::: footer
:::

---


### `gridmappr` for generating layouts


![](img/1213_spacers_grid_empty.png){.absolute top=140 left=20 width="40%"}
![](img/1213_spacers_grid.png){.absolute top=140 left=450 width="40%"}

:::{.fragment .fade-in}
![](img/1213_spacers_empty.png){.absolute top=140 left=20 width="40%"}

![](img/1213_spacers.png){.absolute top=140 left=450 width="40%"}

:::

::: footer
:::

::: {.notes}

1. And we can also add in spacers -- reserved cells that cannot be allocated to the grid. This helps us to, for example, separate non-contiguous geographies.  

:::


---

# `ggplot2` for gridmap design 

---

<!-- ### `ggplot2` for gridmap design  -->

### Create `sf` gridmap object
  
  
:::{.columns}

::: {.column width="40%" style="font-size: 50%;"}

<br><br>
```{r}
#| eval: false
#| echo: false
#| code-line-numbers: "6"
make_grid(france, n_row, n_col) |> 
   ggplot() +
   geom_sf() 
```


:::

::: {.column width="60%"}

![](img/example_poly_france.png){.absolute top=90 left=530 width="55%"}


::: 
:::  
   
::: footer
:::
  
::: {.notes}

* Once layout is generated, it is straightforward to use in standard 
ggplot2. 
*  Handing over to ggplot2 as soon as possible -- because 
it provides a really useful structure/framework for generating an analysis.
* Demonstrate this through an analysis of 2021 Census travel to work data in London
* Returning to some analysis that I did some time ago with 2011 data.
* Also: Think about *what is it* that these sorts of layouts -- and maps more generally -- hope to achieve?
  
  
:::
  
  
---

<!-- ### `ggplot2` for gridmap design  -->
 
### Create `sf` gridmap object 
  
:::{.columns}

::: {.column width="40%" style="font-size: 60%;"}

<br><br>
```{r}
#| eval: false
#| echo: true
make_grid(france, n_row, n_col) |> 
   ggplot() +
   geom_sf() 
```


:::

::: {.column width="60%"}

![](img/example_poly_grid2.png){.absolute top=90 left=530 width="55%"}


::: 
:::  
   
::: footer
:::
  
::: {.notes}
  
:::
  
  
---

### Create `sf` gridmap object
  
  
:::{.columns}

::: {.column width="40%" style="font-size: 60%;"}

<br><br>
```{r}
#| eval: false
#| echo: true
#| code-line-numbers: "2,5"
make_grid(france, n_row, n_col) |> 
   inner_join(solution) |>
   ggplot() +
   geom_sf() 
```


:::

::: {.column width="60%"}

![](img/example_poly2.png){.absolute top=90 left=530 width="55%"}


::: 
:::  
   
::: footer
:::
  
::: {.notes}
  
:::

---

<!-- ### `ggplot2` for gridmap design  -->
### Plot `sf` gridmap object

  
:::{.columns}

::: {.column width="40%" style="font-size: 60%;"}

<br><br>
```{r}
#| eval: false
#| echo: true
#| code-line-numbers: "2,5,6,7"
make_grid(france, n_row, n_col) |> 
   inner_join(solution) |>
   ggplot() +
   geom_sf() +
   geom_text(
     aes(x=x, y=y, label=area_name)
   ) 
```


:::

::: {.column width="60%"}

![](img/grid_labels.png){.absolute top=90 left=530 width="55%"}


::: 
:::  
   
::: footer
:::
  
::: {.notes}
  
:::

---

### Plot `sf` gridmap object
  
  
:::{.columns}

::: {.column width="40%" style="font-size: 60%;"}

<br><br>
```{r}
#| eval: false
#| echo: true
#| code-line-numbers: "8,9,10"
make_grid(france, n_row, n_col) |> 
   inner_join(solution) |>
   ggplot() +
   geom_sf() +
   geom_text(
     aes(x=x, y=y, label=area_name)
   ) +
   geom_point(
     aes(x, y, size=perimeter)
  )
```


:::

::: {.column width="60%"}

![](img/grid_poly_point.png){.absolute top=90 left=530 width="55%"}


::: 
:::  
   
::: footer
:::
  
::: {.notes}
  
:::

---

### gridmap via `facet_grid()` 
  
  
:::{.columns}

::: {.column width="40%" style="font-size: 60%;"}

![](img/bar.png){.absolute top=110 left=10 width="40%"}

:::

::: {.column width="60%"}

![](img/facet_bar.png){.absolute top=115 left=580 width="50%"}


::: 
:::  
   
::: footer
:::
  
::: {.notes}
  
:::

---

### gridmap via `facet_grid()` 
  
  
:::{.columns}

::: {.column width="40%" style="font-size: 60%;"}


<br><br>
```{r}
#| eval: false
#| echo: true
#| code-line-numbers: "1,3,4,5,10"
france_ods |> 
   ggplot() +
   geom_col(
    aes(x=rank, y=dist)
   ) +
  geom_text(
    data=. %>% filter(o_name==d_name), 
    aes(x=x, y=y, label=d_name)
  ) +
  facet_wrap(~d_name) 
```


:::

::: {.column width="60%"}

![](img/facet_bar.png){.absolute top=115 left=580 width="50%"}


::: 
:::  
   
::: footer
:::
  
::: {.notes}
  
:::

---


### gridmap via `facet_grid()` 
  
  
:::{.columns}

::: {.column width="40%" style="font-size: 60%;"}

<br><br>
```{r}
#| eval: false
#| echo: true
#| code-line-numbers: "1,3,4,5,10"
france_ods |> 
   ggplot() +
   geom_col(
    aes(x=rank, y=dist)
   ) +
  geom_text(
    data=. %>% filter(o_name==d_name), 
    aes(x=x, y=y, label=d_name)
  ) +
  facet_grid(-d_row~d_col) 
```


:::

::: {.column width="60%"}

![](img/bars_outline.png){.absolute top=90 left=530 width="55%"}


::: 
:::  
   
::: footer
:::
  
::: {.notes}
  
:::

---

### OD maps via `facet_grid()` + `sf` object
  

![](img/paper_od_map.png){.absolute top=130 left=10 width="50%"}
  ![](img/odmap_paper_france.png){.absolute top=130 left=600 width="35%"}

 ![](img/odmap_paper_us.png){.absolute top=330 left=580 width="40%"}

::: footer

:::

---

### OD maps via `facet_grid()` + `sf` object


:::{.columns}

::: {.column width="40%" style="font-size: 60%;"}

<br><br>
```{r}
#| eval: false
#| echo: true
france_ods |> 
  left_join(france, by=c("o_name"="name")) |>
  ggplot() +
  geom_sf(
    data= . %>% filter(is_focus)
    ) +
  facet_grid(-d_row ~ d_col) 
```


:::

::: {.column width="60%"}

![](img/odmap_france_empty.png){.absolute top=90 left=530 width="55%"}


::: 
:::  
   
::: footer

:::
  
::: {.notes}
  
:::

---

### OD maps via `facet_grid()` + `sf` object
  
  
:::{.columns}

::: {.column width="40%" style="font-size: 60%;"}

<br><br>
```{r}
#| eval: false
#| echo: true
#| code-line-numbers: "7"
france_ods |> 
  left_join(france, by=c("o_name"="name")) |>
  ggplot() +
  geom_sf(
    data= . %>% filter(is_focus)
    ) +
  geom_sf(aes(fill=dist)) +
  facet_grid(-d_row ~ d_col) 
```


:::

::: {.column width="60%"}

![](img/odmap_france.png){.absolute top=90 left=530 width="55%"}


::: 
:::  
   
::: footer

:::
  
::: {.notes}
  
:::

---

### OD maps via `facet_grid()` + `sf` object
  
  
:::{.columns}

::: {.column width="40%" style="font-size: 60%;"}

<br><br>
```{r}
#| eval: false
#| echo: true
#| code-line-numbers: "2"
france_ods |> 
  left_join(france_grid, by=c("o_name"="name")) |>
  ggplot() +
  geom_sf(
    data= . %>% filter(is_focus)
    ) +
  geom_sf(aes(fill=dist)) +
  facet_grid(-d_row ~ d_col) 
```


:::

::: {.column width="60%"}

![](img/odmap_france_grid.png){.absolute top=90 left=530 width="55%"}


::: 
:::  
   
::: footer

:::
  
::: {.notes}
  
:::

---

# `tidyverse` for gridmap analysis

---

### `tidyverse` for gridmap analysis


Model building with Census data 
gridmap code suggests *condition*   for models 

   
::: footer

:::

---


### `tidyverse` for gridmap analysis
  
wider ecosystem (purrr::) eases process of visually testing features
  
::: footer

:::
  
::: {.notes}
:::


---



